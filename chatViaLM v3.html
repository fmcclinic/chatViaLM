<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Chatbot LM Studio</title>
    <style>
        /* Base styles */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            height: 100vh;
            display: grid;
            grid-template-columns: 250px 1fr;
        }

        /* Settings panel */
        .settings-panel {
            background: #f8f9fa;
            padding: 15px;
            border-right: 1px solid #ddd;
            overflow-y: auto;
        }

        .settings-group {
            margin-bottom: 20px;
        }

        .settings-group h3 {
            margin-bottom: 10px;
            color: #333;
        }

        .setting-item {
            margin-bottom: 10px;
        }

        .setting-item label {
            display: block;
            margin-bottom: 5px;
        }

        .setting-item input[type="range"],
        .setting-item input[type="number"],
        .setting-item select,
        .setting-item textarea {
            width: 100%;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        /* Main chat area */
        .main-area {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        .toolbar {
            padding: 10px;
            border-bottom: 1px solid #ddd;
            display: flex;
            gap: 10px;
        }

        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 20px;
            overflow-y: auto;
        }

        .message {
            max-width: 80%;
            margin: 8px;
            padding: 12px;
            border-radius: 8px;
            animation: fadeIn 0.3s;
        }

        .user {
            background: #007bff;
            color: white;
            align-self: flex-end;
        }

        .bot {
            background: #f1f1f1;
            align-self: flex-start;
        }

        .input-area {
            padding: 20px;
            border-top: 1px solid #ddd;
            display: flex;
            gap: 10px;
        }

        input[type="text"] {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }

        button {
            padding: 10px 20px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        button:hover {
            background: #0056b3;
        }

        button:disabled {
            background: #ccc;
        }

        .loading {
            opacity: 0.7;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Utilities */
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="settings-panel">
        <div class="settings-group">
            <h3>API Settings</h3>
            <div class="setting-item">
                <label>Temperature</label>
                <input type="range" id="temperature" min="0" max="1" step="0.1" value="0.7">
                <span id="temperature-value">0.7</span>
            </div>
            <div class="setting-item">
                <label>Max Tokens</label>
                <input type="number" id="max-tokens" value="200" min="1" max="2000">
            </div>
            <div class="setting-item">
                <label>Top P</label>
                <input type="range" id="top-p" min="0" max="1" step="0.1" value="1">
                <span id="top-p-value">1.0</span>
            </div>
            <div class="setting-item">
                <label>Presence Penalty</label>
                <input type="range" id="presence-penalty" min="-2" max="2" step="0.1" value="0">
                <span id="presence-penalty-value">0</span>
            </div>
            <div class="setting-item">
                <label>Frequency Penalty</label>
                <input type="range" id="frequency-penalty" min="-2" max="2" step="0.1" value="0">
                <span id="frequency-penalty-value">0</span>
            </div>
        </div>

        <div class="settings-group">
            <h3>System Prompt</h3>
            <div class="setting-item">
                <textarea id="system-prompt" rows="5"></textarea>
            </div>
        </div>

        <div class="settings-group">
            <h3>Preferences</h3>
            <div class="setting-item">
                <label>Font Size</label>
                <select id="font-size">
                    <option value="14px">Small</option>
                    <option value="16px" selected>Medium</option>
                    <option value="18px">Large</option>
                </select>
            </div>
            <div class="setting-item">
                <label>
                    <input type="checkbox" id="auto-scroll" checked>
                    Auto-scroll
                </label>
            </div>
            <div class="setting-item">
                <label>
                    <input type="checkbox" id="sound-enabled">
                    Sound Notifications
                </label>
            </div>
        </div>
    </div>

    <div class="main-area">
        <div class="toolbar">
            <button onclick="clearChat()">Clear Chat</button>
            <button onclick="exportChat()">Export Chat</button>
        </div>
        
        <div class="chat-container" id="chat-container"></div>
        
        <div class="input-area">
            <input type="text" id="user-input" placeholder="Nhập tin nhắn..." onkeypress="handleKeyPress(event)">
            <button onclick="sendMessage()" id="send-button">Gửi</button>
        </div>
    </div>

    <script>
        // Constants
        const DEFAULT_SYSTEM_PROMPT = `Bạn là một trợ lý AI thông minh và hữu ích. Hãy tuân theo những quy tắc sau:
1. Trả lời ngắn gọn, súc tích và chính xác
2. Chỉ trả lời những gì người dùng hỏi
3. Không tự thêm thông tin không liên quan
4. Luôn trả lời bằng tiếng Việt
5. Nếu không hiểu câu hỏi, hãy yêu cầu làm rõ
6. Không được tự bịa ra thông tin`;

        // State
        let chatHistory = [];
        let isStreaming = false;

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            // Load settings from localStorage
            loadSettings();
            loadChatHistory();
            
            // Initialize range input displays
            document.querySelectorAll('input[type="range"]').forEach(input => {
                input.addEventListener('input', (e) => {
                    document.getElementById(`${e.target.id}-value`).textContent = e.target.value;
                });
            });

            // Initialize font size
            document.getElementById('font-size').addEventListener('change', (e) => {
                document.documentElement.style.setProperty('--font-size', e.target.value);
            });
        });

        // Settings Management
        function loadSettings() {
            const settings = JSON.parse(localStorage.getItem('chatSettings')) || {};
            
            document.getElementById('temperature').value = settings.temperature || 0.7;
            document.getElementById('max-tokens').value = settings.maxTokens || 200;
            document.getElementById('top-p').value = settings.topP || 1;
            document.getElementById('presence-penalty').value = settings.presencePenalty || 0;
            document.getElementById('frequency-penalty').value = settings.frequencyPenalty || 0;
            document.getElementById('system-prompt').value = settings.systemPrompt || DEFAULT_SYSTEM_PROMPT;
            document.getElementById('font-size').value = settings.fontSize || '16px';
            document.getElementById('auto-scroll').checked = settings.autoScroll !== false;
            document.getElementById('sound-enabled').checked = settings.soundEnabled || false;
        }

        function saveSettings() {
            const settings = {
                temperature: parseFloat(document.getElementById('temperature').value),
                maxTokens: parseInt(document.getElementById('max-tokens').value),
                topP: parseFloat(document.getElementById('top-p').value),
                presencePenalty: parseFloat(document.getElementById('presence-penalty').value),
                frequencyPenalty: parseFloat(document.getElementById('frequency-penalty').value),
                systemPrompt: document.getElementById('system-prompt').value,
                fontSize: document.getElementById('font-size').value,
                autoScroll: document.getElementById('auto-scroll').checked,
                soundEnabled: document.getElementById('sound-enabled').checked
            };
            
            localStorage.setItem('chatSettings', JSON.stringify(settings));
        }

        // Chat History Management
        function loadChatHistory() {
            const saved = localStorage.getItem('chatHistory');
            if (saved) {
                chatHistory = JSON.parse(saved);
                chatHistory.forEach(msg => appendMessage(msg.role === 'user', msg.content));
            }
        }

        function saveChatHistory() {
            localStorage.setItem('chatHistory', JSON.stringify(chatHistory));
        }

        function clearChat() {
            chatHistory = [];
            document.getElementById('chat-container').innerHTML = '';
            saveChatHistory();
        }

        function exportChat() {
            const chatText = chatHistory.map(msg => 
                `${msg.role === 'user' ? 'User' : 'Assistant'}: ${msg.content}`
            ).join('\n\n');
            
            const blob = new Blob([chatText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'chat-history.txt';
            a.click();
            URL.revokeObjectURL(url);
        }

        // Message Handling
        async function sendMessage() {
            const inputField = document.getElementById('user-input');
            const sendButton = document.getElementById('send-button');
            const userText = inputField.value.trim();
            
            if (!userText || isStreaming) return;
            
            // Disable input while processing
            inputField.disabled = true;
            sendButton.disabled = true;
            sendButton.classList.add('loading');
            isStreaming = true;

            // Add user message
            appendMessage(true, userText);
            chatHistory.push({ role: 'user', content: userText });

            try {
                const response = await fetch('http://localhost:1234/v1/chat/completions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model: 'vistral-7b-chat',
                        messages: [
                            {
                                role: 'system',
                                content: document.getElementById('system-prompt').value
                            },
                            ...chatHistory
                        ],
                        temperature: parseFloat(document.getElementById('temperature').value),
                        max_tokens: parseInt(document.getElementById('max-tokens').value),
                        top_p: parseFloat(document.getElementById('top-p').value),
                        presence_penalty: parseFloat(document.getElementById('presence-penalty').value),
                        frequency_penalty: parseFloat(document.getElementById('frequency-penalty').value),
                        stream: true
                    })
                });

                if (!response.ok) throw new Error('API request failed');

                let isComplete = false;
                let botReply = '';
                let continuationCount = 0;
                const MAX_CONTINUATIONS = 5;
                const botMessage = appendMessage(false, '');

                while (!isComplete && continuationCount < MAX_CONTINUATIONS) {
                    let currentResponse;
                    if (continuationCount === 0) {
                        currentResponse = response;
                    } else {
                        // Gọi API tiếp với context cũ
                        currentResponse = await fetch('http://localhost:1234/v1/chat/completions', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                model: 'vistral-7b-chat',
                                messages: [
                                    {
                                        role: 'system',
                                        content: document.getElementById('system-prompt').value
                                    },
                                    ...chatHistory,
                                    { role: 'assistant', content: botReply }
                                ],
                                temperature: parseFloat(document.getElementById('temperature').value),
                                max_tokens: parseInt(document.getElementById('max-tokens').value),
                                top_p: parseFloat(document.getElementById('top-p').value),
                                presence_penalty: parseFloat(document.getElementById('presence-penalty').value),
                                frequency_penalty: parseFloat(document.getElementById('frequency-penalty').value),
                                stream: true
                            })
                        });
                    }

                    const reader = currentResponse.body.getReader();
                    let wasLastChunkCut = false;

                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;

                        const chunk = new TextDecoder().decode(value);
                        const lines = chunk.split('\n');
                        
                        for (const line of lines) {
                            if (line.trim() === '' || line.includes('[DONE]')) continue;
                            
                            try {
                                const json = JSON.parse(line.replace(/^data: /, ''));
                                const token = json.choices[0]?.delta?.content || '';
                                const finishReason = json.choices[0]?.finish_reason;

                                botReply += token;
                                botMessage.innerText = botReply + (finishReason === 'length' ? '...' : '');
                                
                                if (document.getElementById('auto-scroll').checked) {
                                    document.getElementById('chat-container').scrollTop = 
                                        document.getElementById('chat-container').scrollHeight;
                                }

                                if (finishReason === 'stop') {
                                    isComplete = true;
                                } else if (finishReason === 'length') {
                                    wasLastChunkCut = true;
                                }
                            } catch (e) {
                                console.error('Error parsing streaming response:', e);
                            }
                        }
                    }

                    if (wasLastChunkCut) {
                        continuationCount++;
                        await new Promise(resolve => setTimeout(resolve, 1000)); // Delay between continuations
                    } else {
                        isComplete = true;
                    }
                }

                if (!isComplete) {
                    botMessage.innerText += '\n[Tin nhắn đã đạt giới hạn độ dài tối đa]';
                }

                // Add final bot message to history
                chatHistory.push({ role: 'assistant', content: botReply });
                
                // Maintain history size
                if (chatHistory.length > 100) {
                    chatHistory = chatHistory.slice(-100);
                }

                // Save history
                saveChatHistory();
                saveSettings();

                // Play sound if enabled
                if (document.getElementById('sound-enabled').checked) {
                    const audio = new Audio('data:audio/mp3;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU4Ljc2LjEwMAAAAAAAAAAAAAAA/+M4wAAAAAAAAAAAAEluZm8AAAAPAAAAAwAAAGQA4ODg4ODg4ODg4ODg4ODg4ODg4ODg4ODg4ODg4ODg4ODg4ODg4ODg4ODg4ODg4ODg//////////////////////////////////////////////////////////////////8AAAAATGF2YzU4LjEzAAAAAAAAAAAAAAAAJAAAAAAAAAAAEOBFzq4AAAAAAAAAAAAAAAAAAAAAA/+MYxAAHmAKwAAAA0Dp+n6HwGDwYDgAC+BwGAwGAMGFQAHgDAMBAGAwGAwGAQGAwGAwIAIGA4DgMGAwGAwGAwGBcDgMBgXA4DAYIAc');
                    audio.play();
                }

            } catch (error) {
                console.error('Error:', error);
                appendMessage(false, 'Xin lỗi, có lỗi xảy ra. Vui lòng thử lại.');
            } finally {
                isStreaming = false;
                inputField.disabled = false;
                sendButton.disabled = false;
                sendButton.classList.remove('loading');
                inputField.value = '';
                inputField.focus();
            }
        }

        function appendMessage(isUser, text) {
            const container = document.getElementById('chat-container');
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message', isUser ? 'user' : 'bot');
            messageDiv.innerText = text;
            container.appendChild(messageDiv);
            
            if (document.getElementById('auto-scroll').checked) {
                container.scrollTop = container.scrollHeight;
            }
            
            return messageDiv;
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        // Error handling retry mechanism
        async function retryWithExponentialBackoff(fn, maxRetries = 3) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    return await fn();
                } catch (error) {
                    if (i === maxRetries - 1) throw error;
                    const waitTime = Math.min(1000 * Math.pow(2, i), 10000);
                    await new Promise(resolve => setTimeout(resolve, waitTime));
                }
            }
        }

        // Rate limiting
        let lastRequestTime = 0;
        const MIN_REQUEST_INTERVAL = 1000; // 1 second

        function checkRateLimit() {
            const now = Date.now();
            if (now - lastRequestTime < MIN_REQUEST_INTERVAL) {
                throw new Error('Please wait before sending another message');
            }
            lastRequestTime = now;
        }
    </script>
</body>
</html>
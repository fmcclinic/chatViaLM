<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Chatbot LM Studio</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* Base styles */
        body {
            margin: 0;
            height: 100vh;
            display: grid;
            grid-template-columns: 250px 1fr;
            font-family: Arial, sans-serif;
        }

        /* Settings Panel */
        .settings-panel {
            background: #f8f9fa;
            padding: 15px;
            border-right: 1px solid #ddd;
            overflow-y: auto;
        }

        .endpoint-config {
            margin-bottom: 20px;
            padding: 10px;
            background: #fff;
            border-radius: 5px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .endpoint-input {
            display: flex;
            gap: 5px;
            margin-bottom: 10px;
        }

        .endpoint-input input, .setting-item select {
            flex: 1;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        /* Connection Status */
        .connection-status {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 4px;
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .status-online {
            background: #28a745;
        }

        .status-offline {
            background: #dc3545;
        }

        .settings-group {
            margin-bottom: 20px;
        }

        .settings-group h3 {
            margin-bottom: 10px;
            color: #333;
        }

        .setting-item {
            margin-bottom: 10px;
        }

        .setting-item label {
            display: block;
            margin-bottom: 5px;
        }

        .setting-item input[type="range"],
        .setting-item input[type="number"],
        .setting-item select,
        .setting-item textarea {
            width: 100%;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        /* Message styles */
        .message-container {
            position: relative;
            max-width: 80%;
            margin: 8px;
            animation: fadeIn 0.3s;
        }

        .message {
            padding: 12px;
            border-radius: 8px;
            line-height: 1.5;
            font-size: 16px;
            white-space: pre-wrap;
        }

        /* Warning Message Style */
        .warning-message {
            font-size: 0.9em;
            color: #856404;
            background-color: #fff3cd;
            border: 1px solid #ffeeba;
            padding: 8px 12px;
            border-radius: 4px;
            margin-top: 8px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .warning-message i {
            color: #856404;
        }

        .message-actions {
            display: none;
            position: absolute;
            right: 10px;
            top: 5px;
            background: rgba(255,255,255,0.9);
            border-radius: 4px;
            padding: 5px;
            gap: 5px;
        }

        .message-container:hover .message-actions {
            display: flex;
        }

        .action-btn {
            background: none;
            border: none;
            padding: 5px;
            cursor: pointer;
            color: #666;
            border-radius: 4px;
        }

        .action-btn:hover {
            background: rgba(0,0,0,0.1);
            color: #333;
        }

        .user-message {
            margin-left: auto;
        }

        .user-message .message {
            background: #007bff;
            color: white;
        }

        .bot-message .message {
            background: #f1f1f1;
            color: #333;
        }

        /* Chat Container */
        .chat-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        .chat-header {
            padding: 15px;
            background: #fff;
            border-bottom: 1px solid #ddd;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: #fff;
        }

        .input-area {
            padding: 20px;
            background: #fff;
            border-top: 1px solid #ddd;
            display: flex;
            gap: 10px;
        }

        .input-area input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }

        /* Feedback styles */
        .feedback-buttons {
            display: flex;
            gap: 5px;
            margin-top: 5px;
            opacity: 0.7;
        }

        .feedback-btn {
            padding: 2px 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .feedback-btn:hover {
            background-color: #f8f9fa;
        }

        .feedback-btn.active {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }

        .feedback-notification {
            font-size: 0.9em;
            padding: 4px 8px;
            margin-top: 4px;
            border-radius: 4px;
            animation: fadeIn 0.3s ease;
        }

        .feedback-notification.thank-you {
            color: #155724;
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
        }

        .improved-note {
            padding: 4px 8px;
            background-color: #f8f9fa;
            border-radius: 4px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9em;
            color: #666;
            animation: fadeIn 0.3s ease;
        }

        .improved-note i {
            color: #28a745;
        }

        /* Edit mode */
        .edit-mode textarea {
            width: 100%;
            min-height: 100px;
            padding: 10px;
            border: 2px solid #007bff;
            border-radius: 8px;
            font-size: 16px;
            margin-bottom: 10px;
        }

        .edit-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        button {
            padding: 8px 15px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        button:hover {
            background: #0056b3;
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .loading {
            opacity: 0.7;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-5px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>
    <div class="settings-panel">
        <div class="endpoint-config">
            <h3>API Endpoint</h3>
            <div class="endpoint-input">
                <input type="text" id="endpoint-input" placeholder="Enter API endpoint" value="http://localhost:1234">
            </div>
            <div class="connection-status">
                <div class="status-indicator" id="status-indicator"></div>
                <span id="status-text">Checking connection...</span>
            </div>
        </div>

        <div class="settings-group">
            <h3>Chat Settings</h3>
            <div class="setting-item">
                <label>Model</label>
                <select id="model-select" class="model-select"></select>
            </div>
            <div class="setting-item">
                <label>Temperature</label>
                <input type="range" id="temperature" min="0" max="1" step="0.1" value="0.5">
                <span id="temperature-value">0.5</span>
            </div>
            <div class="setting-item">
                <label>Max Tokens</label>
                <input type="number" id="max-tokens" value="500" min="1" max="2000">
            </div>
            <div class="setting-item">
                <label>System Prompt</label>
                <textarea id="system-prompt" rows="4"></textarea>
            </div>
        </div>
    </div>

    <div class="chat-container">
        <div class="chat-header">
            <h2>Friend Medical Clinic Chatbot</h2>
            <div class="header-actions">
                <button id="clear-chat-btn" title="Xóa toàn bộ cuộc trò chuyện">
                    <i class="fas fa-trash"></i> Xóa Chat
                </button>
            </div>
        </div>
        <div class="chat-messages" id="chat-messages"></div>
        <div class="input-area">
            <input type="text" 
                   id="user-input" 
                   placeholder="Nhập câu hỏi của bạn..." 
                   aria-label="Message input">
            <button id="send-btn" title="Gửi tin nhắn">
                <i class="fas fa-paper-plane"></i> Gửi
            </button>
        </div>
    </div>

<script>
        // Global variables
        let currentEndpoint = 'http://localhost:1234';
        let chatHistory = JSON.parse(localStorage.getItem('chatHistory') || '[]');
        let availableModels = [];
        let currentModel = 'vistral-7b-chat';
        let isConnected = false;

        const DEFAULT_SYSTEM_PROMPT = `Bạn là chatbot của phòng khám chuyên khoa Friend Medical Clinic, chỉ cung cấp thông tin về sức khỏe và dịch vụ y tế của phòng khám, thông tin chỉ tham khảo không thay thế bác sĩ, nhân viên y tế
Quy tắc hoạt động:
1. Chỉ trả lời các câu hỏi liên quan đến y tế, sức khỏe.
2. Từ chối các chủ đề ngoài phạm vi y tế.
3. không nói đến giá cả xét nghiệm, tên thuốc, hay tiền
4. Tuyệt đối không đề cập đến chính trị, xã hội, bạo lực, tình dục, mãi dâm …
Khi tư vấn, luôn đề cập đến triệu chứng, biến chứng, điều trị, phòng ngừa.
5. Luôn khuyến khích bệnh nhân đến khám trực tiếp tại phòng khám.
Thông tin phòng khám:
Địa chỉ: A12 Saigon Villas Hill, 99 Lê Văn Việt, TP. Thủ Đức, TP. HCM.
Điện thoại: 028 3535 5353
Giờ làm việc:
Thứ 2 - Thứ 7: 8:00 - 20:00
Chủ nhật: 8:00 - 12:00
Chuyên khoa & Đội ngũ bác sĩ
1. Chuyên Khoa Sản Phụ Khoa
Phòng khám có đội ngũ bác sĩ giàu kinh nghiệm từ Bệnh viện Từ Dũ – trung tâm sản khoa hàng đầu khu vực phía Nam.
Các Bác sĩ:
BS. Nguyễn Hoàng Lam (Chuyên khoa II)
BS. Đào Hoàng Hoa Hà Hải Âu (Chuyên khoa I)
BS. Nguyễn Thị Việt Linh (Chuyên khoa I)
Dịch vụ:


Điều trị bệnh lý phụ khoa phức tạp: u xơ tử cung, u nang buồng trứng, tầm soát ung thư cổ tử cung.
Chăm sóc thai sản toàn diện: khám thai định kỳ, sàng lọc trước sinh, hỗ trợ sinh tại Bệnh viện Từ Dũ.
2. Chuyên Khoa Tai Mũi Họng
Phòng khám cung cấp dịch vụ chẩn đoán và điều trị các bệnh lý Tai – Mũi – Họng với hệ thống nội soi hiện đại.
Bác sĩ TMH
BS. Dương Minh Trọng (Chuyên khoa I)
BS. Sử Ngọc Kiều Chinh (Chuyên khoa I)
Dịch vụ:
Điều trị viêm xoang mãn tính, viêm amidan, viêm mũi dị ứng, chảy máu cam …
Tầm soát ung thư vòm họng.
3. Chuyên Khoa Nội
Đội ngũ chuyên gia từ Bệnh viện FV với các lĩnh vực chuyên sâu.
Bác sĩ:
BS. Đỗ Thành Long (Chuyên khoa I)
BS. Nguyễn Anh Hoàng (Chuyên khoa I)
Dịch vụ:
Nội tổng quát: Khám và điều trị bệnh lý thường gặp.
Tim mạch: Chẩn đoán, điều trị bệnh tim mạch, theo dõi sau đặt stent.
Nội tiết – Chuyển hóa: Điều trị đái tháo đường, rối loạn tuyến giáp, bệnh chuyển hóa.
Lưu ý: Phòng khám không có ngoại khoa, nhi khoa, da liễu, nha khoa, nội soi tiêu hóa.


Xét nghiệm tại Diag – Đối tác của Phòng Khám
Friend Medical Clinic hợp tác với Diag, trung tâm xét nghiệm uy tín tại Việt Nam, cung cấp dịch vụ xét nghiệm từ cơ bản đến chuyên sâu.


1. Gói xét nghiệm tổng quát
Cơ bản: Huyết học, sinh hóa, đánh giá chức năng gan, thận.
Nâng cao: Phát hiện viêm gan B, C, bệnh tuyến giáp.
2. Gói xét nghiệm chuyên sâu
Tầm soát ung thư (bao gồm ung thư phụ khoa).
Tầm soát tiểu đường: Đánh giá nguy cơ, kiểm soát bệnh.
Tầm soát chức năng gan, thận: Phát hiện sớm tổn thương gan, thận.
3. Dịch vụ lấy mẫu tại nhà
Nhân viên y tế đến tận nhà lấy mẫu xét nghiệm.
Kết quả trả qua Zalo hoặc SMS trong 24 giờ.`;

        const WELCOME_MESSAGE = `Xin chào! Tôi là chatbot của Friend Medical Clinic. 😊

Tôi có thể giúp bạn:
• Tư vấn về các vấn đề sức khỏe
• Cung cấp thông tin về dịch vụ phòng khám
• Hướng dẫn đặt lịch khám

Cách tương tác với tôi:
👍 Like - Nếu câu trả lời hữu ích
👎 Dislike - Nếu câu trả lời chưa tốt, tôi sẽ trả lời lại
🔄 Tạo lại - Tạo câu trả lời mới
💬 Chi tiết - Yêu cầu thông tin chi tiết hơn

⚠️ Lưu ý quan trọng:
• Thông tin tôi cung cấp chỉ mang tính tham khảo
• Vui lòng tham khảo ý kiến bác sĩ để có hướng dẫn chính xác nhất
• Trong trường hợp khẩn cấp, hãy gọi ngay cho phòng khám: 028 3535 5353

Bạn có thể đặt câu hỏi ngay bây giờ. Tôi sẽ cố gắng hỗ trợ bạn tốt nhất! 🌟`;

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('endpoint-input').value = currentEndpoint;
            document.getElementById('system-prompt').value = DEFAULT_SYSTEM_PROMPT;
            
            document.getElementById('send-btn').addEventListener('click', () => sendMessage());
            document.getElementById('clear-chat-btn').addEventListener('click', clearChat);
            document.getElementById('user-input').addEventListener('keypress', handleKeyPress);
            document.getElementById('temperature').addEventListener('input', handleTemperatureChange);
            document.getElementById('model-select').addEventListener('change', handleModelChange);
            document.getElementById('endpoint-input').addEventListener('change', handleEndpointChange);

            loadChatHistory();
            checkConnection();
        });

        function handleEndpointChange(e) {
            currentEndpoint = e.target.value.trim();
            checkConnection();
        }

        function createMessageElement(isUser, text, messageId) {
            const container = document.createElement('div');
            container.className = `message-container ${isUser ? 'user-message' : 'bot-message'}`;
            container.dataset.messageId = messageId;

            const messageDiv = document.createElement('div');
            messageDiv.className = 'message';
            messageDiv.textContent = text;

            container.appendChild(messageDiv);

            // Add warning message and actions for bot responses
            if (!isUser) {
                const warningDiv = document.createElement('div');
                warningDiv.className = 'warning-message';
                warningDiv.innerHTML = `
                    <i class="fas fa-exclamation-triangle"></i>
                    Lưu ý: Thông tin trên do AI tạo ra, có thể không chính xác. Vui lòng tham khảo ý kiến bác sĩ để có hướng dẫn chính xác nhất.
                `;
                container.appendChild(warningDiv);

                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'message-actions';
                actionsDiv.innerHTML = `
                    <button class="action-btn regenerate-btn" title="Tạo lại câu trả lời">
                        <i class="fas fa-redo"></i>
                    </button>
                    <button class="action-btn follow-up-btn" title="Yêu cầu thông tin chi tiết hơn">
                        <i class="fas fa-reply"></i>
                    </button>
                    <button class="action-btn edit-btn" title="Chỉnh sửa">
                        <i class="fas fa-edit"></i>
                    </button>
                `;

                container.appendChild(actionsDiv);

                // Add event listeners for action buttons
                actionsDiv.querySelector('.regenerate-btn').addEventListener('click', () => regenerateResponse(messageId));
                actionsDiv.querySelector('.follow-up-btn').addEventListener('click', () => askFollowUp(messageId));
                actionsDiv.querySelector('.edit-btn').addEventListener('click', () => editMessage(container));

                const feedbackDiv = document.createElement('div');
                feedbackDiv.className = 'feedback-buttons';
                feedbackDiv.innerHTML = `
                    <button class="feedback-btn" data-feedback="up" title="Hữu ích">
                        <i class="fas fa-thumbs-up"></i>
                    </button>
                    <button class="feedback-btn" data-feedback="down" title="Chưa hữu ích">
                        <i class="fas fa-thumbs-down"></i>
                    </button>
                `;

                feedbackDiv.querySelectorAll('.feedback-btn').forEach(btn => {
                    btn.addEventListener('click', () => handleFeedback(messageId, btn.dataset.feedback));
                });

                container.appendChild(feedbackDiv);
            }

            return container;
        }

        function loadChatHistory() {
            const container = document.getElementById('chat-messages');
            container.innerHTML = '';
            
            if (chatHistory.length === 0) {
                // Add welcome message when there's no chat history
                const welcomeMessageId = Date.now().toString();
                const messageElement = createMessageElement(false, WELCOME_MESSAGE, welcomeMessageId);
                container.appendChild(messageElement);
                
                chatHistory.push({
                    id: welcomeMessageId,
                    role: 'assistant',
                    content: WELCOME_MESSAGE
                });
                localStorage.setItem('chatHistory', JSON.stringify(chatHistory));
            } else {
                // Load existing chat history
                chatHistory.forEach(msg => {
                    const messageElement = createMessageElement(msg.role === 'user', msg.content, msg.id);
                    container.appendChild(messageElement);
                });
            }
            container.scrollTop = container.scrollHeight;
        }

        async function handleFeedback(messageId, feedback) {
            const container = document.querySelector(`[data-message-id="${messageId}"]`);
            const buttons = container.querySelectorAll('.feedback-btn');
            
            // Remove existing feedback notification if any
            const existingNotification = container.querySelector('.feedback-notification');
            if (existingNotification) {
                existingNotification.remove();
            }

            buttons.forEach(btn => {
                btn.classList.toggle('active', btn.dataset.feedback === feedback);
            });

            const messageIndex = chatHistory.findIndex(msg => msg.id === messageId);
            if (messageIndex !== -1) {
                chatHistory[messageIndex].feedback = feedback;
                
                if (feedback === 'down') {
                    // Handle dislike
                    chatHistory[messageIndex].incorrect = true;
                    localStorage.setItem('chatHistory', JSON.stringify(chatHistory));
                    await generateImprovedResponse(messageId, messageIndex);
                } else if (feedback === 'up') {
                    // Handle like - show thank you message
                    const thankYouDiv = document.createElement('div');
                    thankYouDiv.className = 'feedback-notification thank-you';
                    thankYouDiv.innerHTML = '<i class="fas fa-heart"></i> Cảm ơn phản hồi của bạn!';
                    container.appendChild(thankYouDiv);
                    
                    localStorage.setItem('chatHistory', JSON.stringify(chatHistory));
                }
            }
        }

        async function generateImprovedResponse(messageId, incorrectIndex) {
            try {
                const incorrectMessage = chatHistory[incorrectIndex];
                const userMessage = chatHistory[incorrectIndex - 1];

                // Create improved system prompt
                const improvedSystemPrompt = `${document.getElementById('system-prompt').value}

Lưu ý: Câu trả lời trước đã được đánh giá là chưa tốt. Đây là câu trả lời cần cải thiện:
"${incorrectMessage.content}"

Hãy đưa ra câu trả lời mới tốt hơn, chi tiết và chính xác hơn.`;

                const response = await fetch(`${currentEndpoint}/v1/chat/completions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                        'ngrok-skip-browser-warning': 'true'
                    },
                    mode: 'cors',
                    body: JSON.stringify({
                        model: currentModel,
                        messages: [
                            {
                                role: 'system',
                                content: improvedSystemPrompt
                            },
                            userMessage,
                        ],
                        temperature: parseFloat(document.getElementById('temperature').value),
                        max_tokens: parseInt(document.getElementById('max-tokens').value),
                        stream: true
                    })
                });

                if (!response.ok) {
                    throw new Error(`API request failed: ${response.status} ${response.statusText}`);
                }

                const botMessageId = Date.now().toString();
                const botMessage = createMessageElement(false, '', botMessageId);
                
                // Add improvement note
                const improvedNote = document.createElement('div');
                improvedNote.className = 'improved-note';
                improvedNote.innerHTML = `<i class="fas fa-sync"></i> Câu trả lời đã được cải thiện dựa trên feedback`;
                botMessage.insertBefore(improvedNote, botMessage.firstChild);
                
                // Replace old message
                const oldMessage = document.querySelector(`[data-message-id="${messageId}"]`);
                if (oldMessage) {
                    oldMessage.replaceWith(botMessage);
                }
                
                const botMessageContent = botMessage.querySelector('.message');
                const reader = response.body.getReader();
                let botReply = '';

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    const chunk = new TextDecoder().decode(value);
                    const lines = chunk.split('\n');
                    
                    for (const line of lines) {
                        if (line.trim() === '' || line.includes('[DONE]')) continue;
                        
                        try {
                            const json = JSON.parse(line.replace(/^data: /, ''));
                            const token = json.choices[0]?.delta?.content || '';
                            
                            if (token) {
                                botReply += token;
                                botMessageContent.textContent = botReply;
                                document.getElementById('chat-messages').scrollTop = 
                                    document.getElementById('chat-messages').scrollHeight;
                            }
                        } catch (e) {
                            console.error('Error parsing streaming response:', e, 'Line:', line);
                        }
                    }
                }

                if (botReply.trim()) {
                    chatHistory.push({ 
                        id: botMessageId,
                        role: 'assistant', 
                        content: botReply,
                        improvedFrom: messageId
                    });
                    localStorage.setItem('chatHistory', JSON.stringify(chatHistory));
                }

            } catch (error) {
                console.error('Error in generateImprovedResponse:', error);
                const errorMessage = createMessageElement(
                    false, 
                    `Lỗi: Không thể tạo câu trả lời cải thiện. ${error.message}`, 
                    Date.now().toString()
                );
                const oldMessage = document.querySelector(`[data-message-id="${messageId}"]`);
                if (oldMessage) {
                    oldMessage.replaceWith(errorMessage);
                }
            }
        }

        async function regenerateResponse(messageId) {
            const messageIndex = chatHistory.findIndex(msg => msg.id === messageId);
            if (messageIndex === -1) return;

            try {
                // Lấy tin nhắn gần nhất của user
                const lastUserMessage = chatHistory[messageIndex - 1];
                if (!lastUserMessage || lastUserMessage.role !== 'user') return;

                // Cắt bỏ tin nhắn cũ
                chatHistory = chatHistory.slice(0, messageIndex);
                localStorage.setItem('chatHistory', JSON.stringify(chatHistory));
                
                // Add regeneration note
                const noteDiv = document.createElement('div');
                noteDiv.className = 'improved-note';
                noteDiv.innerHTML = `<i class="fas fa-redo"></i> Đang tạo lại câu trả lời...`;
                
                const oldMessage = document.querySelector(`[data-message-id="${messageId}"]`);
                if (oldMessage) {
                    oldMessage.appendChild(noteDiv);
                }

                const response = await fetch(`${currentEndpoint}/v1/chat/completions`, {
                    method: 'POST',
                    headers: {
'Content-Type': 'application/json',
                        'Accept': 'application/json',
                        'ngrok-skip-browser-warning': 'true'
                    },
                    mode: 'cors',
                    body: JSON.stringify({
                        model: currentModel,
                        messages: [
                            {
                                role: 'system',
                                content: document.getElementById('system-prompt').value
                            },
                            ...chatHistory
                        ],
                        temperature: parseFloat(document.getElementById('temperature').value),
                        max_tokens: parseInt(document.getElementById('max-tokens').value),
                        stream: true
                    })
                });

                if (!response.ok) {
                    throw new Error(`API request failed: ${response.status} ${response.statusText}`);
                }

                const botMessageId = Date.now().toString();
                const botMessage = createMessageElement(false, '', botMessageId);
                
                // Replace old message
                if (oldMessage) {
                    oldMessage.replaceWith(botMessage);
                }
                
                const botMessageContent = botMessage.querySelector('.message');
                const reader = response.body.getReader();
                let botReply = '';

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    const chunk = new TextDecoder().decode(value);
                    const lines = chunk.split('\n');
                    
                    for (const line of lines) {
                        if (line.trim() === '' || line.includes('[DONE]')) continue;
                        
                        try {
                            const json = JSON.parse(line.replace(/^data: /, ''));
                            const token = json.choices[0]?.delta?.content || '';
                            
                            if (token) {
                                botReply += token;
                                botMessageContent.textContent = botReply;
                                document.getElementById('chat-messages').scrollTop = 
                                    document.getElementById('chat-messages').scrollHeight;
                            }
                        } catch (e) {
                            console.error('Error parsing streaming response:', e, 'Line:', line);
                        }
                    }
                }

                if (botReply.trim()) {
                    chatHistory.push({ 
                        id: botMessageId,
                        role: 'assistant', 
                        content: botReply 
                    });
                    localStorage.setItem('chatHistory', JSON.stringify(chatHistory));
                }

            } catch (error) {
                console.error('Error in regenerateResponse:', error);
                const errorMessage = createMessageElement(
                    false, 
                    `Lỗi: Không thể tạo lại câu trả lời. ${error.message}`, 
                    Date.now().toString()
                );
                const oldMessage = document.querySelector(`[data-message-id="${messageId}"]`);
                if (oldMessage) {
                    oldMessage.replaceWith(errorMessage);
                }
            }
        }

        function askFollowUp(messageId) {
            const input = document.getElementById('user-input');
            input.value = "Hãy cung cấp thêm thông tin chi tiết và đầy đủ hơn về nội dung trên";
            input.focus();
            input.setSelectionRange(input.value.length, input.value.length);
        }

        function editMessage(container) {
            const messageDiv = container.querySelector('.message');
            const originalText = messageDiv.textContent;
            
            const editDiv = document.createElement('div');
            editDiv.className = 'edit-mode';
            editDiv.innerHTML = `
                <textarea>${originalText}</textarea>
                <div class="edit-buttons">
                    <button class="save-btn">Lưu</button>
                    <button class="cancel-btn">Hủy</button>
                </div>
            `;

            messageDiv.replaceWith(editDiv);

            const textarea = editDiv.querySelector('textarea');
            textarea.focus();
            textarea.setSelectionRange(textarea.value.length, textarea.value.length);

            editDiv.querySelector('.save-btn').addEventListener('click', () => {
                const newText = editDiv.querySelector('textarea').value;
                messageDiv.textContent = newText;
                editDiv.replaceWith(messageDiv);
                
                const messageId = container.dataset.messageId;
                const messageIndex = chatHistory.findIndex(msg => msg.id === messageId);
                if (messageIndex !== -1) {
                    chatHistory[messageIndex].content = newText;
                    localStorage.setItem('chatHistory', JSON.stringify(chatHistory));
                }
            });

            editDiv.querySelector('.cancel-btn').addEventListener('click', () => {
                editDiv.replaceWith(messageDiv);
            });
        }

        function clearChat() {
            if (confirm('Bạn có chắc muốn xóa toàn bộ cuộc trò chuyện không?')) {
                chatHistory = [];
                localStorage.setItem('chatHistory', JSON.stringify(chatHistory));
                loadChatHistory(); // This will load the welcome message again
            }
        }

        async function checkConnection() {
            const indicator = document.getElementById('status-indicator');
            const statusText = document.getElementById('status-text');

            try {
                const response = await fetch(`${currentEndpoint}/v1/models`, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json',
                        'ngrok-skip-browser-warning': 'true'
                    },
                    mode: 'cors'
                });

                const rawText = await response.text();
                let data;
                try {
                    data = JSON.parse(rawText);
                } catch (e) {
                    throw new Error(`Invalid JSON response. Raw response: ${rawText.substring(0, 100)}...`);
                }

                if (!data || !data.data) {
                    throw new Error('Invalid API response format');
                }

                if (Array.isArray(data.data)) {
                    availableModels = data.data;
                    updateModelSelects();
                }

                isConnected = true;
                indicator.className = 'status-indicator status-online';
                statusText.textContent = 'Đã kết nối';
                return data;

            } catch (error) {
                isConnected = false;
                indicator.className = 'status-indicator status-offline';
                statusText.textContent = `Lỗi kết nối: ${error.message}`;
                console.error('Connection error:', error);
                throw error;
            }
        }

        function updateModelSelects() {
            const modelSelect = document.getElementById('model-select');
            modelSelect.innerHTML = availableModels
                .map(model => `<option value="${model.id}" ${model.id === currentModel ? 'selected' : ''}>${model.id}</option>`)
                .join('');
        }

        function handleModelChange(e) {
            currentModel = e.target.value;
        }

        function handleTemperatureChange(e) {
            document.getElementById('temperature-value').textContent = e.target.value;
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        async function sendMessage(isRegenerate = false) {
            if (!isConnected) {
                alert('Vui lòng kiểm tra kết nối đến API endpoint.');
                return;
            }

            const inputField = document.getElementById('user-input');
            const sendButton = document.getElementById('send-btn');
            const userText = inputField.value.trim();

            if (!userText) return;

            try {
                inputField.disabled = true;
                sendButton.disabled = true;
                sendButton.classList.add('loading');

                const messageId = Date.now().toString();
                const messageElement = createMessageElement(true, userText, messageId);
                document.getElementById('chat-messages').appendChild(messageElement);

                chatHistory.push({ 
                    id: messageId,
                    role: 'user', 
                    content: userText 
                });

                const response = await fetch(`${currentEndpoint}/v1/chat/completions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                        'ngrok-skip-browser-warning': 'true'
                    },
                    mode: 'cors',
                    body: JSON.stringify({
                        model: currentModel,
                        messages: [
                            {
                                role: 'system',
                                content: document.getElementById('system-prompt').value
                            },
                            ...chatHistory
                        ],
                        temperature: parseFloat(document.getElementById('temperature').value),
                        max_tokens: parseInt(document.getElementById('max-tokens').value),
                        stream: true
                    })
                });

                if (!response.ok) {
                    throw new Error(`API request failed: ${response.status} ${response.statusText}`);
                }

                const reader = response.body.getReader();
                let botReply = '';
                const botMessageId = Date.now().toString();
                const botMessage = createMessageElement(false, '', botMessageId);
                document.getElementById('chat-messages').appendChild(botMessage);
                const botMessageContent = botMessage.querySelector('.message');

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    const chunk = new TextDecoder().decode(value);
                    const lines = chunk.split('\n');
                    
                    for (const line of lines) {
                        if (line.trim() === '' || line.includes('[DONE]')) continue;
                        
                        try {
                            const json = JSON.parse(line.replace(/^data: /, ''));
                            const token = json.choices[0]?.delta?.content || '';
                            
                            if (token) {
                                botReply += token;
                                botMessageContent.textContent = botReply;
                                document.getElementById('chat-messages').scrollTop = 
                                    document.getElementById('chat-messages').scrollHeight;
                            }
                        } catch (e) {
                            console.error('Error parsing streaming response:', e, 'Line:', line);
                        }
                    }
                }

                if (botReply.trim()) {
                    chatHistory.push({ 
                        id: botMessageId,
                        role: 'assistant', 
                        content: botReply 
                    });
                    
                    if (chatHistory.length > 100) {
                        chatHistory = chatHistory.slice(-100);
                    }
                    localStorage.setItem('chatHistory', JSON.stringify(chatHistory));
                }

            } catch (error) {
                console.error('Error in sendMessage:', error);
                const errorMessage = createMessageElement(
                    false, 
                    `Lỗi: ${error.message}. Vui lòng thử lại.`, 
                    Date.now().toString()
                );
                document.getElementById('chat-messages').appendChild(errorMessage);
            } finally {
                inputField.disabled = false;
                sendButton.disabled = false;
                sendButton.classList.remove('loading');
                inputField.value = '';
                inputField.focus();
            }
        }
    </script>
</body>
</html>
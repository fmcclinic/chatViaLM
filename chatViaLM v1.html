<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chatbot LM Studio</title>
    <style>
        /* CSS giữ nguyên */
        body {
            font-family: Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background-color: #f4f4f4;
        }
        .chat-container {
            width: 400px;
            height: 500px;
            display: flex;
            flex-direction: column;
            border: 1px solid #ddd;
            border-radius: 10px;
            background: white;
            overflow: hidden;
        }
        .chat-box {
            flex: 1;
            padding: 10px;
            overflow-y: auto;
        }
        .message {
            padding: 8px 12px;
            margin: 5px;
            border-radius: 10px;
            max-width: 80%;
        }
        .user {
            background: #007bff;
            color: white;
            align-self: flex-end;
        }
        .bot {
            background: #e0e0e0;
            align-self: flex-start;
        }
        .input-box {
            display: flex;
            padding: 10px;
            border-top: 1px solid #ddd;
        }
        input {
            flex: 1;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        button {
            padding: 8px;
            margin-left: 5px;
            background: #007bff;
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .loading {
            opacity: 0.5;
            pointer-events: none;
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="chat-box" id="chat-box"></div>
        <div class="input-box">
            <input type="text" id="user-input" placeholder="Nhập tin nhắn..." onkeypress="handleKeyPress(event)">
            <button onclick="sendMessage()" id="send-button">Gửi</button>
        </div>
    </div>
    <script>
        let chatHistory = [];
        const systemPrompt = `Bạn là một trợ lý AI thông minh và hữu ích. Hãy tuân theo những quy tắc sau:
1. Trả lời ngắn gọn, súc tích và chính xác
2. Chỉ trả lời những gì người dùng hỏi
3. Không tự thêm thông tin không liên quan
4. Luôn trả lời bằng tiếng Việt
5. Nếu không hiểu câu hỏi, hãy yêu cầu làm rõ
6. Không được tự bịa ra thông tin`;

        async function sendMessage() {
            const inputField = document.getElementById("user-input");
            const chatBox = document.getElementById("chat-box");
            const sendButton = document.getElementById("send-button");
            const userText = inputField.value.trim();
            
            if (!userText) return;
            
            // Disable input while processing
            inputField.disabled = true;
            sendButton.disabled = true;
            sendButton.classList.add('loading');

            // Add user message to chat
            const userMessage = document.createElement("div");
            userMessage.classList.add("message", "user");
            userMessage.innerText = userText;
            chatBox.appendChild(userMessage);
            
            // Update chat history
            chatHistory.push({
                role: "user",
                content: userText
            });

            try {
                const response = await fetch("http://localhost:1234/v1/chat/completions", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        model: "vistral-7b-chat",
                        messages: [
                            {
                                role: "system",
                                content: systemPrompt
                            },
                            ...chatHistory
                        ],
                        temperature: 0.7,
                        max_tokens: 200
                    })
                });

                const data = await response.json();
                const botReply = data.choices[0]?.message?.content || "Xin lỗi, tôi không hiểu.";
                
                // Add bot reply to history
                chatHistory.push({
                    role: "assistant",
                    content: botReply
                });

                // Keep history manageable
                if (chatHistory.length > 10) {
                    chatHistory = chatHistory.slice(-10);
                }

                // Display bot message
                const botMessage = document.createElement("div");
                botMessage.classList.add("message", "bot");
                botMessage.innerText = botReply;
                chatBox.appendChild(botMessage);

            } catch (error) {
                console.error("Lỗi khi gọi API:", error);
                const errorMessage = document.createElement("div");
                errorMessage.classList.add("message", "bot");
                errorMessage.innerText = "Xin lỗi, có lỗi xảy ra. Vui lòng thử lại.";
                chatBox.appendChild(errorMessage);
            } finally {
                // Re-enable input
                inputField.disabled = false;
                sendButton.disabled = false;
                sendButton.classList.remove('loading');
                inputField.value = "";
                chatBox.scrollTop = chatBox.scrollHeight;
            }
        }

        function handleKeyPress(event) {
            if (event.key === "Enter") {
                sendMessage();
            }
        }
    </script>
</body>
</html>